{
  "id": "97CD97A9-9F1A-419C-B6FA-368C574192A1",
  "name": "Deploy a Python app to Azure App Service and Azure MySQL",
  "category": "Deployment",
  "iconTaskId": "6392F95F-7E76-4A18-B3C7-7F078D2F7700",
  "description": "Deploy a Python Django, Bottle, or Flask application to an Azure Web App and database to Azure Database for MySQL.",
  "environment": {
    "name": "Production",
    "rank": 1,
    "deployPhases": [
      {
        "name": "Run on agent",
        "rank": 1,
        "phaseType": 1,
        "controlOptions": {},
        "deploymentInput": {
          "queueId": 1,
          "runOptions": {},
          "demands": []
        },
        "workflowTasks": [
          {
            "taskId": "f045e430-8704-11e6-968f-e717e6411619",
            "version": "0.*",
            "Name": "Install Python 3.5.3 x86 Extension",
            "inputs": {
              "ConnectedServiceName": "$(Parameters.ConnectedServiceName)",
              "WebAppName": "$(Parameters.WebAppName)",
              "Action": "Install Extensions",
              "ExtensionsList": "python353x86",
              "OutputVariable": "PYTHON_EXT"
            },
            "Enabled": true,
            "AlwaysRun": false,
            "ContinueOnError": false
          },
          {
            "taskId": "497d490f-eea7-4f2b-ab94-48d9c1acdcb1",
            "version": "4.*",
            "Name": "Deploy Azure App Service",
            "inputs": {
              "ConnectedServiceName": "$(Parameters.ConnectedServiceName)",
              "WebAppName": "$(Parameters.WebAppName)",
              "WebAppKind": "$(Parameters.WebAppKind)",
              "DeployToSlotOrASEFlag": "false",
              "ResourceGroupName": "",
              "DockerNamespace": "$(Parameters.DockerNamespace)",
              "DockerRepository": "$(Parameters.DockerRepository)",
              "StartupCommand": "$(Parameters.StartupCommand)",
              "Package": "$(System.DefaultWorkingDirectory)/**/*.zip",
              "WebAppUri": "",
              "GenerateWebConfig": "true",
              "WebConfigParameters": "$(Parameters.PythonAppFramework)",
              "UseWebDeploy": "false",
              "SetParametersFile": "",
              "RemoveAdditionalFilesFlag": "false",
              "ExcludeFilesFromAppDataFlag": "false",
              "TakeAppOfflineFlag": "false",
              "AdditionalArguments": "",
              "ScriptType": "Inline Script",
              "InlineScript": "@echo off\nif NOT exist requirements.txt (\n echo No Requirements.txt found.\n EXIT /b 0\n)\nif NOT exist \"$(PYTHON_EXT)/python.exe\" (\n echo Python extension not available >&2\n EXIT /b 1\n)\necho Installing dependencies\ncall \"$(PYTHON_EXT)/python.exe\" -m pip install -U setuptools\nif %errorlevel% NEQ 0 (\n echo Failed to install setuptools >&2\n EXIT /b 1\n)\ncall \"$(PYTHON_EXT)/python.exe\" -m pip install -r requirements.txt\nif %errorlevel% NEQ 0 (\n echo Failed to install dependencies>&2\n EXIT /b 1\n)"
            },
            "Enabled": true,
            "AlwaysRun": false,
            "ContinueOnError": false
          },
          {
            "taskId": "bd1bed02-f04e-11e7-8c3f-9a214cf093ae",
            "version": "1.*",
            "Name": "Azure MySQL DB Deploy",
            "inputs": {
              "ConnectedServiceName": "$(Parameters.ConnectedServiceName)",
              "ServerName": "$(Parameters.ServerName)",
              "DatabaseName": "$(Parameters.DatabaseName)",
              "SqlUsername": "$(Parameters.SqlUsername)",
              "SqlPassword": "$(Parameters.SqlPassword)",
              "TaskNameSelector": "$(Parameters.TaskNameSelector)",
              "SqlFile": "$(Parameters.SqlFile)",
              "SqlInline": "$(Parameters.SqlInline)"
            },
            "Enabled": true,
            "AlwaysRun": false,
            "ContinueOnError": false
          }
        ]
      }
    ],
    "deployStep": {
      "tasks": []
    },
    "preDeployApprovals": {
      "approvals": [
        {
          "isAutomated": true,
          "rank": 1
        }
      ],
      "approvalOptions": null
    },
    "postDeployApprovals": {
      "approvals": [
        {
          "isAutomated": true,
          "rank": 1
        }
      ],
      "approvalOptions": null
    },
    "runOptions": {},
    "executionPolicy": {
      "concurrencyCount": 1,
      "queueDepthCount": 0
    },
    "processParameters": {
      "inputs": [
        {
          "options": {},
          "properties": {},
          "name": "ConnectedServiceName",
          "label": "{ConnectedServiceNameLabel}",
          "defaultValue": "",
          "required": true,
          "type": "connectedService:AzureRM",
          "helpMarkDown": "{ConnectedServiceNameMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "options": {
            "webApp": "Web App on Windows",
            "webAppLinux": "Web App on Linux",
            "webAppContainer": "Web App for Containers (Linux)",
            "functionApp": "Function App on Windows",
            "functionAppLinux": "Function App on Linux",
            "functionAppContainer": "Function App for Containers (Linux)",
            "apiApp": "API App",
            "mobileApp": "Mobile App"
          },
          "properties": {
            "EditableOptions": "false"
          },
          "name": "WebAppKind",
          "label": "{WebAppKindLabel}",
          "defaultValue": "webApp",
          "type": "pickList",
          "helpMarkDown": "",
          "groupName": ""
        },
        {
          "options": {},
          "properties": {
            "EditableOptions": "True"
          },
          "name": "WebAppName",
          "label": "{WebAppNameLabel}",
          "defaultValue": "",
          "required": true,
          "type": "pickList",
          "helpMarkDown": "{WebAppNameMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "options": {},
          "properties": {},
          "name": "DockerNamespace",
          "label": "{DockerNamespaceLabel}",
          "defaultValue": "",
          "required": true,
          "type": "string",
          "helpMarkDown": "{DockerNamespaceMarkdown}",
          "visibleRule": "WebAppKind = webAppContainer || WebAppkind = functionAppContainer",
          "groupName": ""
        },
        {
          "options": {},
          "properties": {},
          "name": "DockerRepository",
          "label": "{DockerRepositoryLabel}",
          "defaultValue": "",
          "required": true,
          "type": "string",
          "helpMarkDown": "{DockerRepositoryMarkdown}",
          "visibleRule": "WebAppKind = webAppContainer || WebAppkind = functionAppContainer",
          "groupName": ""
        },
        {
          "name": "StartupCommand",
          "type": "string",
          "label": "{StartupCommandLabel}",
          "defaultValue": "",
          "required": false,
          "visibleRule": "WebAppKind = webAppLinux || WebAppKind = webAppContainer || WebAppkind = functionAppContainer || WebAppKind = functionAppLinux",
          "helpMarkDown": "{StartupCommandMarkdown}",
          "groupName": ""
        },
        {
          "options": {
            "-WSGI_HANDLER app.wsgi_app()  -PYTHON_PATH $(PYTHON_EXT)\\python.exe -PYTHON_WFASTCGI_PATH $(PYTHON_EXT)\\wfastcgi.py -appType python_Bottle": "Bottle",
            "-WSGI_HANDLER django.core.wsgi.get_wsgi_application()  -PYTHON_PATH $(PYTHON_EXT)\\python.exe -PYTHON_WFASTCGI_PATH $(PYTHON_EXT)\\wfastcgi.py -DJANGO_SETTINGS_MODULE -appType python_Django": "Django",
            "-WSGI_HANDLER main.app  -PYTHON_PATH $(PYTHON_EXT)\\python.exe -PYTHON_WFASTCGI_PATH $(PYTHON_EXT)\\wfastcgi.py -STATIC_FOLDER_PATH static -appType python_Flask": "Flask"
          },
          "properties": {},
          "name": "PythonAppFramework",
          "label": "{PythonAppFramework}",
          "defaultValue": "",
          "required": true,
          "type": "pickList",
          "groupName": "",
          "visibleRule": "WebAppKind != applinux"
        },
        {
          "aliases": [],
          "options": {},
          "properties": { "EditableOptions": "True" },
          "name": "ServerName",
          "label": "{ServerNameLabel}",
          "defaultValue": "",
          "required": true,
          "type": "pickList",
          "helpMarkDown": "{ServerNameMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {},
          "properties": {},
          "name": "DatabaseName",
          "label": "{DatabaseNameLabel}",
          "defaultValue": "",
          "type": "string",
          "helpMarkDown": "{DatabaseNameMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {},
          "properties": {},
          "name": "SqlUsername",
          "label": "{SqlUsernameLabel}",
          "defaultValue": "",
          "required": true,
          "type": "string",
          "helpMarkDown": "{SqlUsernameMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {},
          "properties": {},
          "name": "SqlPassword",
          "label": "{SqlPasswordLabel}",
          "defaultValue": "",
          "required": true,
          "type": "string",
          "helpMarkDown": "{SqlPasswordMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {
            "SqlTaskFile": "MySQL Script File",
            "InlineSqlTask": "Inline MySQL Script"
          },
          "properties": {},
          "name": "TaskNameSelector",
          "label": "{TaskNameSelectorLabel}",
          "defaultValue": "SqlTaskFile",
          "required": true,
          "type": "pickList",
          "helpMarkDown": "{TaskNameSelectorMarkdown}",
          "visibleRule": "",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {},
          "properties": {},
          "name": "SqlFile",
          "label": "{SqlFileLabel}",
          "defaultValue": "",
          "required": true,
          "type": "filePath",
          "helpMarkDown": "{SqlFileMarkdown}​",
          "visibleRule": "TaskNameSelector = SqlTaskFile",
          "groupName": ""
        },
        {
          "aliases": [],
          "options": {},
          "properties": {
            "resizable": "true",
            "rows": "10"
          },
          "name": "SqlInline",
          "label": "{SqlInlineLabel}",
          "defaultValue": " ",
          "required": true,
          "type": "multiLine",
          "helpMarkDown": "{SqlInlineMarkdown}",
          "visibleRule": "TaskNameSelector = InlineSqlTask",
          "groupName": ""
        }
      ],
      "dataSourceBindings": [
        {
          "dataSourceName": "AzureRMWebAppNamesByAppType",
          "parameters": {
            "WebAppKind": "$(WebAppKind)"
          },
          "endpointId": "$(ConnectedServiceName)",
          "target": "WebAppName"
        },
        {
          "dataSourceName": "AzureMysqlServers",
          "parameters": {},
          "endpointId": "$(ConnectedServiceName)",
          "target": "ServerName",
          "resultTemplate": "{ \"Value\" : \"{{{properties.fullyQualifiedDomainName}}}\", \"DisplayValue\" : \"{{{properties.fullyQualifiedDomainName}}}\" }"
        }
      ]
    }
  }
}